# Анализ Repomix: что можно перенять для SwiftIndex

## Что такое Repomix

[Repomix](https://github.com/yamadashy/repomix) — CLI-инструмент, который упаковывает весь репозиторий в один AI-оптимизированный файл для подачи в LLM (Claude, ChatGPT и др.). Написан на TypeScript/Node.js. 70k+ звезд на GitHub, победитель JSNation Awards 2025.

**Ключевые возможности Repomix:**
- Упаковка репозитория в один файл (XML/Markdown/JSON/Plain Text)
- Tree-sitter компрессия кода (~70% меньше токенов)
- Secretlint интеграция для обнаружения секретов
- Подсчет токенов (tiktoken)
- Git-контекст (коммиты, диффы, частота изменений)
- Обработка удаленных репозиториев по URL
- MCP-сервер с 6 инструментами
- Claude Agent Skills генерация
- Browser extensions и VS Code extension

---

## Сравнительный анализ

| Возможность | Repomix | SwiftIndex | Статус |
|---|---|---|---|
| Упаковка в один файл | XML/MD/JSON/Plain | Нет | **Перенять** |
| Компрессия кода (Tree-sitter) | ~70% сжатие токенов | Tree-sitter есть, но для парсинга | **Перенять** |
| Обнаружение секретов | Secretlint | Только OAuth-токены | **Перенять** |
| Точный подсчет токенов | tiktoken (o200k_base) | Приблизительный (content.count / 4) | **Перенять** |
| Git-контекст | Коммиты, диффы, частота | Только .git исключение | **Перенять** |
| Удаленные репозитории | git clone по URL | Push/pull индексов | **Перенять** |
| Удаление комментариев | Да | Нет | Опционально |
| Разделение вывода | По размеру (chunks) | Нет | Полезно |
| Сортировка по частоте изменений | git log анализ | Нет | **Перенять** |
| MCP-сервер | 6 инструментов | 6 инструментов | Паритет |
| Agent Skills | Генерация .claude/skills/ | Нет | Интересно |
| Семантический поиск | Нет | BM25 + Semantic + RRF | **Преимущество SwiftIndex** |
| Локальные эмбеддинги | Нет | MLX на Apple Silicon | **Преимущество SwiftIndex** |
| Инкрементальная индексация | Нет | FileWatcher + incremental | **Преимущество SwiftIndex** |
| LLM-синтез результатов | Нет | QueryExpander + ResultSynthesizer | **Преимущество SwiftIndex** |

---

## План: что перенять

### 1. Точный подсчет токенов (Приоритет: ВЫСОКИЙ)

**Проблема:** SwiftIndex использует грубую оценку `content.count / 4`, что неточно для Swift-кода с длинными идентификаторами.

**Решение:** Реализовать подсчет на основе BPE-токенизатора.

**Варианты:**
- **swift-tiktoken** — Swift-порт tiktoken (если существует)
- **Собственный BPE** — реализовать кодировку cl100k_base/o200k_base
- **Оценка по словам** — компромисс: считать по whitespace-разделителям с коэффициентом, что точнее чем `/4`

**Где применить:**
- `CodeChunk.tokenCount` — точный подсчет для каждого чанка
- Вывод в поиске — показывать реальные токены
- MCP `search_code` — передавать точные метрики
- Команда оценки — `swiftindex stats` для оценки контекстного окна

**Файлы:** `Sources/SwiftIndexCore/Models/CodeChunk.swift`, `InfoSnippet.swift`

---

### 2. Обнаружение секретов перед индексацией (Приоритет: ВЫСОКИЙ)

**Проблема:** SwiftIndex индексирует всё содержимое без проверки на наличие API-ключей, паролей, токенов. Это может привести к утечке через MCP-сервер или поисковую выдачу.

**Решение:** Добавить проверку секретов на этапе индексации.

**Реализация:**
```
SecretScanner protocol
├── RegexSecretScanner       — паттерны для известных секретов
├── EntropySecretScanner     — высокая энтропия строк (опционально)
└── CompositeSecretScanner   — объединение стратегий
```

**Паттерны для обнаружения:**
- AWS ключи (`AKIA[0-9A-Z]{16}`)
- GitHub токены (`gh[ps]_[A-Za-z0-9_]{36,}`)
- Anthropic ключи (`sk-ant-[a-zA-Z0-9-]+`)
- Приватные ключи (`-----BEGIN (RSA|DSA|EC) PRIVATE KEY-----`)
- Generic пароли в конфигах (`password\s*=\s*["\']`)
- JWT токены (`eyJ[A-Za-z0-9-_]+\.eyJ[A-Za-z0-9-_]+`)

**Поведение:**
- По умолчанию: предупреждение в CLI, пропуск чанков с секретами
- `--no-security-check` для отключения
- Настройка в `.swiftindex.toml`:
  ```toml
  [security]
  enable_secret_scan = true
  custom_patterns = ["MY_SECRET_[A-Z]+"]
  ```

**Файлы:** Новый модуль `Sources/SwiftIndexCore/Security/SecretScanner.swift`, интеграция в `IndexManager`

---

### 3. Git-контекст: сортировка по частоте изменений (Приоритет: СРЕДНИЙ)

**Проблема:** SwiftIndex ранжирует результаты только по BM25 + семантике. Часто изменяемые файлы обычно более релевантны для разработчика.

**Решение:** Добавить git-сигнал в ранжирование.

**Реализация:**
- `GitAnalyzer` — извлекает статистику из `git log`
  - Частота изменений файла за последние N коммитов
  - Количество авторов (hot files)
  - Время последнего изменения
- Хранение в `CodeChunk` или отдельной таблице `file_git_stats`
- Буст в `HybridSearchEngine`:
  - Недавно измененные файлы: 1.1x буст
  - Высокая частота изменений: 1.05-1.15x буст
  - Настраиваемые веса через конфиг

**Конфигурация:**
```toml
[search.ranking]
git_recency_boost = 1.1      # буст для недавно измененных
git_frequency_boost = 1.1    # буст для часто изменяемых
git_max_commits = 500        # глубина анализа
```

**Файлы:** Новый `Sources/SwiftIndexCore/Git/GitAnalyzer.swift`, обновление `HybridSearchEngine.swift`

---

### 4. Экспорт контекста (pack-команда) (Приоритет: СРЕДНИЙ)

**Проблема:** SwiftIndex индексирует и ищет, но не может упаковать релевантный контекст в один файл для LLM.

**Решение:** Команда `swiftindex pack` — собирает контекст на основе поискового запроса или набора файлов.

**Варианты использования:**
1. `swiftindex pack --query "authentication flow"` — найти релевантный код и упаковать
2. `swiftindex pack --files "Sources/Auth/**"` — упаковать указанные файлы
3. `swiftindex pack --budget 50000` — ограничение по токенам

**Формат вывода:**
```xml
<repository>
  <summary>
    <total_files>15</total_files>
    <total_tokens>32000</total_tokens>
  </summary>
  <directory_structure>...</directory_structure>
  <files>
    <file path="Sources/Auth/AuthManager.swift" tokens="1200">
      <content>...</content>
    </file>
  </files>
</repository>
```

**Отличие от Repomix:** SwiftIndex может использовать семантический поиск для умного отбора файлов, а не просто упаковывать всё. Это даст "smart pack" — упаковку только релевантного контекста.

**MCP интеграция:** Новый инструмент `pack_context` в MCP-сервере.

**Файлы:** Новая команда `Sources/swiftindex/Commands/PackCommand.swift`, новый модуль `Sources/SwiftIndexCore/Pack/`

---

### 5. Tree-sitter компрессия для контекста (Приоритет: СРЕДНИЙ)

**Проблема:** При передаче кода в LLM тело функций часто избыточно — важнее сигнатуры, типы, структура.

**Решение:** Режим компрессии, который извлекает только структуру кода.

**Что извлекать:**
- Сигнатуры функций/методов (без тела)
- Определения типов (struct, class, enum, protocol)
- Свойства с типами
- Расширения с conformances
- Импорты
- Документационные комментарии

**Пример:**
```swift
// Полный код (100 токенов)
func authenticate(user: String, password: String) -> Result<Token, AuthError> {
    guard !user.isEmpty else { return .failure(.emptyUser) }
    let hash = SHA256.hash(data: Data(password.utf8))
    // ... 20 строк логики
    return .success(token)
}

// Компрессированный (20 токенов)
func authenticate(user: String, password: String) -> Result<Token, AuthError> { /* ... */ }
```

**Интеграция:** Флаг `--compress` в команде `pack` и в MCP.

**Файлы:** Расширение существующих парсеров в `Sources/SwiftIndexCore/Parsing/`

---

### 6. Обработка удаленных репозиториев (Приоритет: НИЗКИЙ)

**Проблема:** SwiftIndex работает только с локальными кодовыми базами.

**Решение:** Команда `swiftindex index --remote <url>`.

**Реализация:**
- Клонирование в временную директорию (shallow clone для скорости)
- Индексация как обычно
- Опциональное сохранение индекса для повторного использования
- Поддержка веток: `--remote-branch main`

**Ограничения:**
- Только публичные репозитории (или с настроенным SSH)
- Swift-фокус: может автоматически определять Swift-проекты

**Файлы:** Расширение `IndexCommand.swift`, новый `Sources/SwiftIndexCore/Git/RemoteCloner.swift`

---

### 7. Генерация Claude Agent Skills (Приоритет: НИЗКИЙ)

**Проблема:** SwiftIndex уже устанавливается как MCP-сервер, но не генерирует Skills для Claude Code.

**Решение:** Команда `swiftindex generate-skill` которая создает `.claude/skills/` структуру на основе проиндексированного кода.

**Что генерируется:**
```
.claude/skills/<project-name>/
├── SKILL.md           — описание проекта и инструкции
└── references/
    ├── summary.md     — обзор архитектуры (из LLM-синтеза)
    ├── structure.md   — структура проекта (из parse-tree)
    ├── files.md       — список файлов с описаниями
    └── tech-stack.md  — технологии и зависимости
```

**Преимущество SwiftIndex:** Может генерировать более качественные описания благодаря семантическому пониманию кода.

**Файлы:** Новая команда `Sources/swiftindex/Commands/GenerateSkillCommand.swift`

---

## Приоритизация

| # | Функция | Приоритет | Сложность | Ценность |
|---|---------|-----------|-----------|----------|
| 1 | Точный подсчет токенов | Высокий | Низкая | Высокая |
| 2 | Обнаружение секретов | Высокий | Средняя | Высокая |
| 3 | Git-контекст в ранжировании | Средний | Средняя | Средняя |
| 4 | Pack-команда (умная упаковка) | Средний | Средняя | Высокая |
| 5 | Tree-sitter компрессия | Средний | Низкая | Средняя |
| 6 | Удаленные репозитории | Низкий | Средняя | Низкая |
| 7 | Claude Agent Skills | Низкий | Низкая | Низкая |

---

## Что НЕ стоит перенимать

1. **Упаковка всего репозитория в один файл** — SwiftIndex решает проблему иначе (индексация + умный поиск), слепое копирование всего кода в файл не нужно. Pack-команда с семантическим отбором — лучший подход.

2. **Browser/VS Code extensions** — SwiftIndex работает как CLI/MCP, это достаточно. Extensions добавляют maintenance burden.

3. **Множество форматов конфигурации** (TS/JS/JSON5/JSONC) — TOML достаточен и проще.

4. **Удаление комментариев** — комментарии ценны для семантического поиска (docComment уже используется в SwiftIndex).

---

## Вывод

Repomix и SwiftIndex решают связанные, но разные задачи:
- **Repomix** = "упакуй всё для LLM" (dump-подход)
- **SwiftIndex** = "найди нужное в коде" (search-подход)

Главные заимствования — это **безопасность** (секреты), **точность метрик** (токены), **git-сигналы** (ранжирование) и **pack-команда** (умная упаковка контекста). При этом SwiftIndex имеет фундаментальные преимущества в семантическом понимании кода, которые Repomix не может предоставить.
