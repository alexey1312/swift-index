# Результаты бенчмарка v5

## Сводная таблица

| #  | Запрос                               | Категория   | SwiftIndex v5 | Изменение vs v4 | Примечание                                |
| -- | ------------------------------------ | ----------- | ------------- | --------------- | ----------------------------------------- |
| 1  | `HybridSearchEngine`                 | A: Точный   | 5/5 ✓         | =               | Идеально                                  |
| 2  | `USearchError`                       | A: Точный   | 1/5           | ↑ (было 0/5)    | **Улучшение!** SearchTokenizationTests #1 |
| 3  | `EmbeddingProvider`                  | A: Точный   | 5/5 ✓         | =               | Идеально                                  |
| 4  | `rrfK`                               | A: Точный   | 5/5 ✓         | =               | Идеально                                  |
| 5  | `text vectorization`                 | B: Синоним  | 5/5 ✓         | =               | Идеально                                  |
| 6  | `store vectors persistently`         | B: Синоним  | 5/5 ✓         | =               | Идеально                                  |
| 7  | `nearest neighbor search`            | B: Синоним  | 3/5           | =               | Comparable extensions всё ещё #1-2        |
| 8  | `combine search results`             | B: Синоним  | 5/5 ✓         | =               | HybridSearchEngine.search #2              |
| 9  | `how does search ranking work`       | C: Концепт  | 5/5 ✓         | =               | applyRankingBoosts найден                 |
| 10 | `how are code chunks parsed`         | C: Концепт  | 5/5 ✓         | =               | TreeSitterParser chunks                   |
| 11 | `what happens when file indexed`     | C: Концепт  | 5/5 ✓         | =               | indexFile, recordIndexed                  |
| 12 | `how are embedding failures handled` | C: Концепт  | 4/5           | =               | embeddings references                     |
| 13 | `actor pattern for thread safety`    | D: Паттерн  | 5/5 ✓         | =               | 5 актеров найдено                         |
| 14 | `what implements ChunkStore`         | D: Паттерн  | 4/5 ✓         | =               | MockChunkStore, ChunkStore protocol       |
| 15 | `how are providers configured`       | D: Паттерн  | 5/5 ✓         | =               | EmbeddingProviderRegistry                 |
| 16 | `where is caching used`              | D: Паттерн  | 5/5 ✓         | =               | cachePath, caching tests                  |
| 17 | `async await concurrency`            | E: Сквозной | 5/5 ✓         | =               | concurrentBatching                        |
| 18 | `error types and handling`           | E: Сквозной | 5/5 ✓         | =               | MCPError, TaskError                       |
| 19 | `TOML config loading validation`     | E: Сквозной | 5/5 ✓         | =               | TOMLConfigValidator                       |
| 20 | `how is search engine tested`        | E: Сквозной | 5/5 ✓         | =               | E2ETests, SearchEngine protocol           |

## Детальный анализ изменений

### Ключевое улучшение: `USearchError` (0/5 → 1/5)

**Это главное улучшение v5!**

Результат #1 теперь содержит реальный код с `USearchError`:

```
[1] SearchTokenizationTests.swift:36
    let results = try await store.searchFTS(query: "USearchError", limit: 10)
```

Это тест, который проверяет поиск по точному идентификатору. Раньше этот код не индексировался или не находился из-за проблем с токенизацией.

**Почему улучшение произошло:**

1. Расширенное покрытие (241 vs 115 файлов) — тесты теперь индексируются
2. Возможно, улучшенная токенизация FTS5 (unicode61)

**Оставшаяся проблема:** Результаты #2-5 всё ещё нерелевантны (BM25Search, TOMLConfig.search и т.д.)

### Стабильность

17 из 20 запросов показали идентичные результаты с v4. Это говорит о стабильности алгоритма поиска.

### Проблема `nearest neighbor search`

По-прежнему Comparable extensions занимают #1 и #2:

- `SearchResult : Comparable`
- `InfoSnippetSearchResult : Comparable`

USearchVectorStore (HNSW implementation) появляется только в тестах на #4-5.

**Причина:** BM25 матчит "search" в "SearchResult", а семантика недостаточно сильная для компенсации.

## Анализ по категориям

### Категория A: Точные ключевые слова (4 запроса)

| Метрика          | v3   | v4   | v5  | Изменение v4→v5 |
| ---------------- | ---- | ---- | --- | --------------- |
| Avg P@5          | 3.75 | 3.75 | 4.0 | ↑ +0.25         |
| Побед SwiftIndex | 0    | 0    | 0   | =               |

**Вывод:** Улучшение на `USearchError` подняло среднюю точность.

### Категория B: Синонимы и варианты (4 запроса)

| Метрика          | v3  | v4  | v5  | Изменение v4→v5 |
| ---------------- | --- | --- | --- | --------------- |
| Avg P@5          | 4.5 | 4.5 | 4.5 | =               |
| Побед SwiftIndex | 3   | 3   | 3   | =               |

**Вывод:** Стабильно.

### Категория C: Вопросы о реализации (4 запроса)

| Метрика          | v3   | v4   | v5   | Изменение v4→v5 |
| ---------------- | ---- | ---- | ---- | --------------- |
| Avg P@5          | 4.75 | 4.75 | 4.75 | =               |
| Побед SwiftIndex | 4    | 4    | 4    | =               |

**Вывод:** Стабильно отлично.

### Категория D: Паттерны и дизайн (4 запроса)

| Метрика          | v3   | v4   | v5   | Изменение v4→v5 |
| ---------------- | ---- | ---- | ---- | --------------- |
| Avg P@5          | 4.75 | 4.75 | 4.75 | =               |
| Побед SwiftIndex | 4    | 4    | 4    | =               |

**Вывод:** Стабильно отлично.

### Категория E: Сквозные вопросы (4 запроса)

| Метрика          | v3 | v4 | v5 | Изменение v4→v5 |
| ---------------- | -- | -- | -- | --------------- |
| Avg P@5          | 5  | 5  | 5  | =               |
| Побед SwiftIndex | 4  | 4  | 4  | =               |

**Вывод:** Идеально!

## Итоговый счёт

| Метрика           | v3   | v4   | v5   | Изменение v4→v5 |
| ----------------- | ---- | ---- | ---- | --------------- |
| Побед SwiftIndex  | 15   | 15   | 15   | =               |
| Ничьих            | 3    | 3    | 3    | =               |
| Поражений         | 2    | 2    | 2    | =               |
| **Avg P@5 (все)** | 4.55 | 4.55 | 4.60 | ↑ +0.05         |

**Победитель:** SwiftIndex (незначительное улучшение)

## Сравнение версий

| Версия | Avg P@5 | Побед | Ничьих | Поражений | Ключевое изменение                          |
| ------ | ------- | ----- | ------ | --------- | ------------------------------------------- |
| v1     | 3.9     | 8     | 7      | 5         | Baseline                                    |
| v2     | 4.35    | 13    | 3      | 4         | RRF Fusion                                  |
| v3     | 4.55    | 15    | 3      | 2         | Type Declarations                           |
| v4     | 4.55    | 15    | 3      | 2         | Exact Search (без явного эффекта)           |
| v5     | 4.60    | 15    | 3      | 2         | Snippets + расширенное покрытие (241 files) |

## Метрики для отслеживания

| Метрика                 | v4     | v5     | Целевое | Статус |
| ----------------------- | ------ | ------ | ------- | ------ |
| Avg P@5 (все запросы)   | 4.55/5 | 4.60/5 | 4.5/5   | ✓      |
| Avg P@5 (точные)        | 3.75/5 | 4.0/5  | 4.5/5   | ↑      |
| Avg P@5 (синонимы)      | 4.5/5  | 4.5/5  | 4.8/5   | =      |
| Avg P@5 (концепты)      | 4.75/5 | 4.75/5 | 4.5/5   | ✓      |
| "implements X" точность | 80%    | 80%    | 90%     | =      |
| Win rate vs grep        | 75%    | 75%    | 75%     | ✓      |

## Выводы

1. **USearchError улучшился** — первый релевантный результат найден (1/5 vs 0/5)
2. **Стабильность** — 17/20 запросов показали идентичные результаты
3. **Расширенное покрытие** — 241 файл vs 115, 8425 chunks vs 6512
4. **Snippets работают** — документация индексируется (но фильтруется через `extensions: swift`)

### Рекомендации для v6

1. **nearest neighbor search** — демоция Comparable extensions для концептуальных запросов
2. **USearchError** — нужен более агрессивный exact match boost для редких CamelCase терминов
3. **Добавить GRDBChunkStore** в результаты "implements ChunkStore" (сейчас только Mock)
