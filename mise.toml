# =============================================================================
# mise Configuration for swift-index
# =============================================================================
# This file defines project tools, tasks, and environment variables.
#
# Bootstrap Binary:
# -----------------
# Use ./bin/mise to run mise commands. It will auto-download mise if needed.
#
# Usage:
#   ./bin/mise install    # Install all tools
#   ./bin/mise run build  # Run build task
#   ./bin/mise run test   # Run tests
# =============================================================================

[settings]
lockfile = true
experimental = true
legacy_version_file = false

# =============================================================================
# Git Hooks (native git mechanism via core.hooksPath)
# =============================================================================
# Hooks are stored in .githooks/ directory (tracked in repo)
# Auto-configures on directory entry via hooks.enter

[hooks.enter]
run = "git config core.hooksPath .githooks 2>/dev/null || true"

# =============================================================================
# Tools
# =============================================================================

[tools]
# --- Swift Development ---
swift = "6.2.3"        # Swift compiler and toolchain
xcsift = "1.1.0"       # A Swift parses output
swiftformat = "0.58.7" # Swift code formatting
swiftlint = "0.63.1"   # Swift linting

# --- Documentation & Formatting ---
dprint = "0.51.1" # MD/JSON/YAML formatting (Rust, fast)

# --- Git & CI ---
hk = "1.32.0"         # Git hooks manager
actionlint = "1.7.10" # GitHub Actions linting

# --- Configuration ---
pkl = "0.30.2" # Configuration language (for hk.pkl)

# =============================================================================
# Tasks
# =============================================================================

[tasks.build]
description = "Build the Swift package (debug)"
run = "swift build 2>&1 | xcsift"

[tasks."build:release"]
description = "Build the Swift package (release)"
run = """
set -euo pipefail
swift build --configuration release -Xswiftc -no-whole-module-optimization 2>&1 | xcsift
./scripts/build-mlx-metallib
"""

[tasks.test]
description = "Run all tests"
run = "swift test 2>&1 | xcsift"

[tasks."test:filter"]
description = "Run tests with filter (usage: mise run test:filter SwiftIndexCoreTests)"
run = "swift test --filter {{arg(name='filter')}} 2>&1 | xcsift"

[tasks.lint]
description = "Run SwiftLint and actionlint"
run = """
swiftlint lint --strict Sources Tests
actionlint
"""

[tasks."lint:fix"]
description = "Run SwiftLint with auto-fix"
run = "swiftlint lint --fix Sources Tests"

[tasks."format:swift"]
description = "Format Swift code"
run = "swiftformat Sources Tests"

[tasks."format-check:swift"]
description = "Check Swift code formatting (CI)"
run = "swiftformat Sources Tests --lint"

[tasks."format:md"]
description = "Format markdown files"
run = "dprint fmt"

[tasks."format-check:md"]
description = "Check markdown formatting (CI)"
run = "dprint check"

[tasks.format]
description = "Format all files (Swift + Markdown)"
run = "hk fix --all 2>&1 | grep -E '^(✔|✗|hk )' || true"

[tasks.format-check]
description = "Check all formatting (CI)"
run = """
set -o pipefail
hk check --all 2>&1 | grep -E '^(✔|✗|hk )'
"""

[tasks.setup]
description = "Configure git hooks"
run = """
git config core.hooksPath .githooks
echo "✓ Git hooks configured: $(git config core.hooksPath)"
"""

[tasks.pre-commit]
description = "Run all pre-commit checks"
run = """
set -o pipefail
hk check --all 2>&1 | grep -E '^(✔|✗|hk )'
"""

[tasks.clean]
description = "Clean build artifacts"
run = "swift package clean && rm -rf .build"
